<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">S-CLOUD</title>
    
    <!-- Standard Meta Tags -->
    <meta name="description" id="page-description" content="S-CLOUD - Stream music from Saavn, YouTube Music, and YouTube Videos. High-quality audio streaming with lofi effects.">
    <meta name="keywords" content="music streaming, saavn, youtube music, audio player, lofi, songs">
    <meta name="author" content="S-CLOUD">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" id="og-title" content="S-CLOUD">
    <meta property="og:description" id="og-description" content="S-CLOUD - Stream music from Saavn, YouTube Music, and YouTube Videos">
    <meta property="og:image" id="og-image" content="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=1200&h=630&fit=crop">
    <meta property="og:url" id="og-url" content="">
    <meta property="og:type" content="music.song">
    <meta property="og:site_name" content="S-CLOUD">
    <meta property="music:duration" id="music-duration" content="">
    <meta property="music:album" id="music-album" content="">
    <meta property="music:musician" id="music-musician" content="">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitter-title" content="S-CLOUD">
    <meta name="twitter:description" id="twitter-description" content="S-CLOUD - Stream music from Saavn, YouTube Music, and YouTube Videos">
    <meta name="twitter:image" id="twitter-image" content="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=1200&h=630&fit=crop">
    <meta name="twitter:creator" content="@scloud">
    
    <!-- Music Platform Meta Tags -->
    <meta property="music:preview_url" id="music-preview" content="">
    <meta property="music:release_date" id="music-release" content="">
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json" id="structured-data">
    {
        "@context": "https://schema.org",
        "@type": "MusicRecording",
        "name": "S-CLOUD",
        "description": "Stream music from multiple platforms",
        "url": "",
        "image": "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=1200&h=630&fit=crop"
    }
    </script>
    
    <!-- Canonical URL -->
    <link rel="canonical" id="canonical-url" href="">
    
    <!-- External Resources -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <style>
        :root {
            --dynamic-primary: #3b82f6;
            --dynamic-secondary: #1e40af;
            --dynamic-accent: #60a5fa;
            --progress-color: #3b82f6;
            --progress-dark: #1e40af;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--dynamic-primary) rgba(255, 255, 255, 0.05);
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
        }

        *::-webkit-scrollbar-thumb {
            background: var(--dynamic-primary);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--dynamic-accent);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            transition: background 1s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: white;
        }

        /* Text ellipsis */
        .text-ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-ellipsis-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Floating Search Bar */
        .floating-search {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .search-input-container:focus-within {
            border-color: var(--dynamic-primary);
            background: rgba(10, 10, 20, 0.95);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        .search-input {
            flex: 1;
            padding: 14px 20px 14px 50px;
            background: transparent;
            border: none;
            color: white;
            font-size: 15px;
            outline: none;
            font-weight: 500;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
        }

        /* Search Suggestions */
        .suggestions-container {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(10, 10, 20, 0.98);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1100;
        }

        .suggestion-item {
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .suggestion-item:first-child {
            border-radius: 20px 20px 0 0;
        }

        .suggestion-item:last-child {
            border-radius: 0 0 20px 20px;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: white;
        }

        .suggestion-icon {
            color: rgba(255, 255, 255, 0.4);
            font-size: 13px;
        }

        /* Compact Navigation */
        .nav-container {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 999;
            background: rgba(10, 10, 20, 0.75);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border-radius: 24px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
        }

        .nav-item:last-child {
            margin-bottom: 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1) translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--dynamic-primary), var(--dynamic-accent));
            border-color: var(--dynamic-primary);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: scale(1.15) translateY(-3px);
        }

        .nav-icon {
            font-size: 18px;
            transition: all 0.4s ease;
            color: rgba(255, 255, 255, 0.8);
        }

        .nav-item.active .nav-icon {
            color: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .saavn-icon {
            width: 18px;
            height: 18px;
            filter: brightness(0.8);
            transition: all 0.4s ease;
        }

        .nav-item.active .saavn-icon {
            filter: brightness(1.6) drop-shadow(0 2px 8px rgba(255, 255, 255, 0.4));
        }

        /* Tooltip */
        .nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .nav-item:hover::after {
            opacity: 1;
            transform: translateY(-50%) translateX(8px);
        }

        /* Main content */
        .main-content {
            margin-left: 90px;
            padding-top: 100px;
            padding-bottom: 120px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .loader {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--dynamic-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* List Items */
        .ytm-list-item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 3px;
        }

        .ytm-list-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .ytm-list-item.playing {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border-left: 4px solid var(--dynamic-primary);
            padding-left: 10px;
        }

        .ytm-thumbnail {
            flex-shrink: 0;
            margin-right: 14px;
            border-radius: 8px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .ytm-thumbnail.music {
            width: 48px;
            height: 48px;
        }

        .ytm-thumbnail.video {
            width: 85px;
            height: 48px;
        }

        .ytm-content {
            flex: 1;
            min-width: 0;
        }

        .ytm-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ytm-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ytm-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            margin-left: 12px;
            flex-shrink: 0;
            font-size: 18px;
        }

        .ytm-list-item:hover .ytm-play-btn {
            opacity: 1;
        }

        .ytm-play-btn:hover {
            background: var(--dynamic-primary);
            transform: scale(1.15);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2.5rem 0 1rem 0;
            padding: 0 16px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
        }

        .show-all-btn {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .show-all-btn:hover {
            background: var(--dynamic-primary);
            color: white;
            transform: translateY(-2px);
        }

        /* Floating Mini Player with Full-Height Progress */
        .mini-player {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            height: 72px;
            border-radius: 20px;
            z-index: 1000;
            overflow: hidden;
            display: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mini-player.active {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .mini-player:hover {
            transform: translateX(-50%) translateY(-4px);
        }

        /* Full-height progress overlay */
        .mini-player-progress-overlay {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            height: 100%;
            background: linear-gradient(135deg, var(--progress-color), var(--dynamic-accent));
            width: 0%;
            transition: width 0.1s ease;
            opacity: 0.3;
            border-radius: 20px;
            pointer-events: none;
        }

        .mini-player-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        .mini-player-content {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            height: 100%;
            gap: 12px;
            z-index: 2;
        }

        .mini-player-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .mini-player-artwork {
            flex-shrink: 0;
            margin-right: 12px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }

        .mini-player-artwork.square {
            width: 48px;
            height: 48px;
        }

        .mini-player-artwork.rectangle {
            width: 72px;
            height: 48px;
        }

        .mini-player-details {
            flex: 1;
            min-width: 0;
        }

        .mini-player-details h4 {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 2px;
            color: white;
        }

        .mini-player-details p {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .mini-player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mini-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 28px;
        }

        .mini-control-btn:hover {
            color: var(--dynamic-primary);
            transform: scale(1.1);
        }

        .mini-control-btn.play-pause {
            width: 44px;
            height: 44px;
            font-size: 32px;
        }

        .lofi-toggle-mini {
            width: 42px;
            height: 22px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 11px;
            display: flex;
            align-items: center;
            padding: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .lofi-toggle-mini.active {
            background: var(--dynamic-primary);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .lofi-toggle-knob-mini {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Expanded Player */
        .expanded-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(5, 5, 15, 0.5);
            backdrop-filter: blur(80px) saturate(180%);
            -webkit-backdrop-filter: blur(80px) saturate(180%);
            z-index: 2000;
            display: none;
            padding: 40px;
            overflow-y: auto;
        }

        .expanded-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(147, 197, 253, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(20, 20, 40, 0.95) 100%);
            pointer-events: none;
        }

        .expanded-player.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .expanded-player-header {
            position: absolute;
            top: 30px;
            left: 30px;
            right: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .expanded-player-title {
            font-size: 15px;
            font-weight: 700;
            color: white;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            padding: 10px 18px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .close-expanded {
            width: 42px;
            height: 42px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 18px;
        }

        .close-expanded:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1) rotate(90deg);
        }

        .expanded-artwork-container {
            position: relative;
            z-index: 5;
            margin-bottom: 35px;
        }

        .expanded-artwork {
            border-radius: 24px;
            object-fit: cover;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .expanded-artwork.square {
            width: 320px;
            height: 320px;
        }

        .expanded-artwork.rectangle {
            width: 440px;
            height: 248px;
        }

        .expanded-artwork-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 24px;
            filter: blur(40px);
            opacity: 0.4;
            z-index: -1;
        }

        .expanded-artwork-glow.square {
            width: 350px;
            height: 350px;
        }

        .expanded-artwork-glow.rectangle {
            width: 470px;
            height: 278px;
        }

        .expanded-info {
            text-align: center;
            margin-bottom: 40px;
            max-width: 440px;
            z-index: 5;
            position: relative;
        }

        .expanded-track-title {
            font-size: 32px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .expanded-track-artist {
            font-size: 19px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .expanded-progress-container {
            width: 100%;
            max-width: 440px;
            margin-bottom: 35px;
            z-index: 5;
            position: relative;
        }

        .expanded-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            margin: 12px 0;
        }

        .expanded-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--dynamic-primary), var(--dynamic-accent));
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
            position: relative;
        }

        .expanded-progress-fill::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .expanded-progress-bar:hover .expanded-progress-fill::after {
            opacity: 1;
        }

        .expanded-time-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
        }

        .expanded-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 5;
            position: relative;
        }

        .expanded-control-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .expanded-control-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .expanded-play-pause {
            width: 72px;
            height: 72px;
            color: white;
            font-size: 48px;
            background: transparent;
        }

        .expanded-play-pause:hover {
            transform: scale(1.08);
            background: transparent;
        }

        /* Loading */
        .loading-indicator {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .floating-search {
                width: 95%;
            }

            .nav-container {
                bottom: 110px;
                left: 50%;
                top: auto;
                transform: translateX(-50%);
                display: flex;
                flex-direction: row;
                padding: 10px 12px;
            }

            .nav-item {
                width: 40px;
                height: 40px;
                margin-bottom: 0;
                margin-right: 10px;
            }

            .nav-item:last-child {
                margin-right: 0;
            }

            .nav-item::after {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 80px 15px 200px 15px;
            }

            .mini-player {
                width: 95%;
            }

            .expanded-artwork.square {
                width: 280px;
                height: 280px;
            }

            .expanded-artwork.rectangle {
                width: 350px;
                height: 197px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Search Bar -->
    <div class="floating-search">
        <form id="search-form" class="search-input-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="search-box" class="search-input" placeholder="Search songs, artists, albums..." autocomplete="off">
        </form>
    </div>

    <!-- Navigation -->
    <nav class="nav-container">
        <button class="nav-item active" data-category="all" data-tooltip="Home">
            <i class="fa-solid fa-house nav-icon"></i>
        </button>
        <button class="nav-item" data-category="saavn" data-tooltip="Saavn">
            <img src="https://veltrixcoder.github.io/stream/saavn.svg" alt="Saavn" class="saavn-icon">
        </button>
        <button class="nav-item" data-category="music" data-tooltip="YouTube Music">
            <i class="fa-solid fa-music nav-icon"></i>
        </button>
        <button class="nav-item" data-category="videos" data-tooltip="YouTube Videos">
            <i class="fa-brands fa-youtube nav-icon"></i>
        </button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div id="search-results"></div>
        </div>
    </main>

    <!-- Floating Mini Player -->
    <footer class="mini-player" id="miniPlayer" onclick="openExpandedPlayer()">
        <div class="mini-player-bg"></div>
        <div class="mini-player-progress-overlay" id="progress"></div>
        <div class="mini-player-content">
            <div class="mini-player-info">
                <img id="player-image" alt="Album" class="mini-player-artwork square">
                <div class="mini-player-details">
                    <h4 id="player-name" class="text-ellipsis">Select a song</h4>
                    <p id="player-album" class="text-ellipsis">Choose from results</p>
                </div>
            </div>

            <div class="mini-player-controls" onclick="event.stopPropagation()">
                <div class="lofi-toggle-mini" id="lofi-toggle" title="Lofi Mode">
                    <div class="lofi-toggle-knob-mini" id="lofi-knob"></div>
                </div>
                <button id="play-pause" class="mini-control-btn play-pause">
                    <i class="fa-solid fa-circle-play"></i>
                </button>
            </div>
        </div>
    </footer>

    <!-- Expanded Player -->
    <div class="expanded-player" id="expandedPlayer">
        <div class="expanded-player-header">
            <div class="expanded-player-title">Now Playing</div>
            <button class="close-expanded" onclick="closeExpandedPlayer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="expanded-artwork-container">
            <img id="expanded-artwork-glow" src="" alt="" class="expanded-artwork-glow square">
            <img id="expanded-artwork" src="" alt="" class="expanded-artwork square">
        </div>
        
        <div class="expanded-info">
            <div class="expanded-track-title text-ellipsis-2" id="expanded-title">Select a song</div>
            <div class="expanded-track-artist text-ellipsis" id="expanded-artist">Choose from results</div>
        </div>
        
        <div class="expanded-progress-container">
            <div class="expanded-progress-bar" onclick="seekToPosition(event)">
                <div class="expanded-progress-fill" id="expanded-progress"></div>
            </div>
            <div class="expanded-time-info">
                <span id="current-time">0:00</span>
                <span id="total-time">0:00</span>
            </div>
        </div>
        
        <div class="expanded-controls">
            <button class="expanded-control-btn" id="expanded-lofi-toggle" title="Lofi Mode">
                <i class="fas fa-wand-magic-sparkles"></i>
            </button>
            <button class="expanded-control-btn" title="Previous">
                <i class="fa-solid fa-backward-step"></i>
            </button>
            <button class="expanded-play-pause" id="expanded-play-pause">
                <i class="fa-solid fa-circle-play"></i>
            </button>
            <button class="expanded-control-btn" title="Next">
                <i class="fa-solid fa-forward-step"></i>
            </button>
            <button class="expanded-control-btn" id="share-btn" title="Share">
                <i class="fa-solid fa-share-nodes"></i>
            </button>
        </div>
    </div>

    <audio id="player" crossorigin="anonymous"></audio>

    <script>
        let currentSongData = null;
        let continuationTokens = { music: null, videos: null, saavn: null };
        let activeSuggestionIndex = -1;
        let currentSuggestions = [];
        let suggestionsContainer = null;
        let isLoadingMore = false;
        let currentQuery = '';
        let hasMoreResults = { music: false, videos: false, saavn: false };

        const API_BASE = "https://js-ruddy-rho.vercel.app";
        const API_ENDPOINTS = {
            saavn: "https://saavn.dev/api/search/songs",
            music: `${API_BASE}/api/search`,
            videos: `${API_BASE}/api/search`,
            suggestions: `${API_BASE}/api/search/suggestions`,
            streams: "http://localhost:9999/streams"
        };

        // Audio Context for Lofi Effect
        let audioContext;
        let sourceNode;
        let reverbNode;
        let gainNode;
        let slowedReverbEnabled = false;
        let audioInitialized = false;

        function debounce(fn, delay = 250) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Media Session
        function initializeMediaSession(title, artist, thumbnail) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title, artist,
                    album: currentSongData?.item?.album?.name || 'S-CLOUD',
                    artwork: [{ src: thumbnail, sizes: '512x512', type: 'image/png' }]
                });

                navigator.mediaSession.setActionHandler('play', () => {
                    document.getElementById('player').play();
                    updatePlayPauseButton(true);
                });

                navigator.mediaSession.setActionHandler('pause', () => {
                    document.getElementById('player').pause();
                    updatePlayPauseButton(false);
                });

                navigator.mediaSession.playbackState = 'playing';
            }
        }

        function updateMediaSessionPlaybackState(state) {
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = state;
        }

        // Routing
        function createSongURL(item, type) {
            const songId = type === 'saavn' ? item.id : type === 'music' ? item.videoId : item.id;
            const title = encodeURIComponent((item.name || item.title || '').replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase());
            return `${window.location.origin}${window.location.pathname}#/play/${type}/${songId}/${title}`;
        }

        function updateURL(item, type) {
            history.pushState({ songData: item, type }, '', createSongURL(item, type));
        }

        function getLowQualityThumbnail(item, type) {
            if (type === 'saavn') return item.image?.[0]?.url || item.image?.[1]?.url || '';
            const url = item.thumbnails?.[0]?.url || '';
            if (url.includes('hqdefault')) return url.replace('hqdefault', 'mqdefault');
            if (url.includes('maxresdefault')) return url.replace('maxresdefault', 'mqdefault');
            return url;
        }

        function getHighQualityThumbnail(item, type) {
            if (type === 'saavn') return item.image?.[2]?.url || item.image?.[1]?.url || item.image?.[0]?.url || '';
            const url = item.thumbnails?.[0]?.url || '';
            if (url.includes('mqdefault')) return url.replace('mqdefault', 'maxresdefault');
            if (url.includes('hqdefault')) return url.replace('hqdefault', 'maxresdefault');
            return url;
        }

        const colorThief = new ColorThief();
        let currentlyPlayingId = null;
        let currentCategory = 'all';
        let searchResults = { saavn: [], music: [], videos: [] };

        // Search Suggestions
        function initSearchSuggestions() {
            const searchBox = document.getElementById('search-box');
            const searchContainer = document.querySelector('.search-input-container');
            
            suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'suggestions-container';
            suggestionsContainer.style.display = 'none';
            searchContainer.appendChild(suggestionsContainer);

            searchBox.addEventListener('input', debounce(async (e) => {
                const query = e.target.value.trim();
                if (!query) { hideSuggestions(); return; }
                try {
                    const res = await fetch(`${API_ENDPOINTS.suggestions}?q=${encodeURIComponent(query)}&music=1`);
                    const data = await res.json();
                    showSuggestions(data.suggestions || []);
                } catch { hideSuggestions(); }
            }, 300));

            searchBox.addEventListener('keydown', (e) => {
                if (!currentSuggestions.length) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestionIndex = Math.min(activeSuggestionIndex + 1, currentSuggestions.length - 1);
                    highlightSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestionIndex = Math.max(activeSuggestionIndex - 1, -1);
                    highlightSuggestion();
                } else if (e.key === 'Enter' && activeSuggestionIndex >= 0) {
                    e.preventDefault();
                    selectSuggestion(currentSuggestions[activeSuggestionIndex]);
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });

            document.addEventListener('click', (e) => {
                if (!searchContainer.contains(e.target)) hideSuggestions();
            });
        }

        function showSuggestions(suggestions) {
            currentSuggestions = suggestions;
            activeSuggestionIndex = -1;
            if (!suggestions.length) { hideSuggestions(); return; }
            suggestionsContainer.innerHTML = suggestions.map((s, i) => `
                <div class="suggestion-item" data-index="${i}">
                    <i class="fas fa-search suggestion-icon"></i>
                    <span>${s.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
                </div>
            `).join('');
            suggestionsContainer.style.display = 'block';
            suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => selectSuggestion(currentSuggestions[parseInt(item.dataset.index)]));
            });
        }

        function hideSuggestions() {
            if (suggestionsContainer) suggestionsContainer.style.display = 'none';
            currentSuggestions = [];
            activeSuggestionIndex = -1;
        }

        function highlightSuggestion() {
            const items = suggestionsContainer.querySelectorAll('.suggestion-item');
            items.forEach((item, i) => {
                if (i === activeSuggestionIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
            if (activeSuggestionIndex >= 0) {
                document.getElementById('search-box').value = currentSuggestions[activeSuggestionIndex];
            }
        }

        function selectSuggestion(suggestion) {
            document.getElementById('search-box').value = suggestion;
            hideSuggestions();
            performSearch();
        }

        // Player
        function openExpandedPlayer() {
            document.getElementById('expandedPlayer').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeExpandedPlayer() {
            document.getElementById('expandedPlayer').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function seekToPosition(event) {
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            const audio = document.getElementById('player');
            if (!isNaN(audio.duration)) audio.currentTime = audio.duration * percent;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Share
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('share-btn')?.addEventListener('click', () => {
                if (currentSongData) {
                    const url = createSongURL(currentSongData.item, currentSongData.type);
                    if (navigator.share) {
                        navigator.share({
                            title: document.getElementById('expanded-title').textContent,
                            url
                        });
                    } else {
                        navigator.clipboard.writeText(url).then(() => showNotification('Link copied!', 'success'));
                    }
                }
            });
            initSearchSuggestions();
        });

        // Theme
        function updateTheme(imageUrl) {
            if (!imageUrl) return;
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function() {
                try {
                    const palette = colorThief.getPalette(img, 8);
                    if (palette?.length) {
                        let best = palette[0], maxV = 0;
                        for (let c of palette) {
                            const [r,g,b] = c;
                            const brightness = (r*299 + g*587 + b*114)/1000;
                            const sat = Math.max(r,g,b) === 0 ? 0 : (Math.max(r,g,b)-Math.min(r,g,b))/Math.max(r,g,b);
                            const v = brightness * sat;
                            if (v > maxV && brightness > 50 && sat > 0.3) { maxV = v; best = c; }
                        }
                        const [r,g,b] = best;
                        const d = (c,f) => Math.floor(c*(1-f));
                        const p = `rgb(${Math.max(d(r,.2),80)}, ${Math.max(d(g,.2),80)}, ${Math.max(d(b,.2),80)})`;
                        const s = `rgb(${Math.max(d(r,.5),40)}, ${Math.max(d(g,.5),40)}, ${Math.max(d(r,.5),40)})`;
                        const a = `rgb(${Math.min(r+30,255)}, ${Math.min(g+30,255)}, ${Math.min(b+30,255)})`;
                        document.documentElement.style.setProperty('--dynamic-primary', p);
                        document.documentElement.style.setProperty('--dynamic-secondary', s);
                        document.documentElement.style.setProperty('--dynamic-accent', a);
                        document.body.style.background = `linear-gradient(135deg, #0a0a0a 0%, ${s} 30%, ${p} 100%)`;
                    }
                } catch(e) {}
            };
            img.src = imageUrl;
        }

        // Search
        document.getElementById('search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            hideSuggestions();
            performSearch();
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                displayResults();
            });
        });

        async function performSearch(loadMore = false, type = null) {
            const query = document.querySelector("#search-box").value.trim();
            if (!query && !loadMore) return;

            if (!loadMore) {
                currentQuery = query;
                continuationTokens = { music: null, videos: null, saavn: null };
                hasMoreResults = { music: false, videos: false, saavn: false };
                window.location.hash = `search/${encodeURIComponent(query)}`;
            }

            const resultsContainer = document.querySelector("#search-results");
            if (!loadMore) {
                resultsContainer.innerHTML = '<div style="text-align:center;padding:60px 20px;"><div class="loader" style="margin:0 auto 20px;"></div><p style="color:rgba(255,255,255,0.6);">Searching...</p></div>';
            }

            const promises = [];

            if (!type || type === 'saavn') {
                if (!loadMore) {
                    promises.push(
                        fetch(`${API_ENDPOINTS.saavn}?query=${encodeURIComponent(currentQuery)}&limit=20`)
                            .then(r => r.json())
                            .then(d => ({ type: 'saavn', data: d.data?.results || [] }))
                            .catch(() => ({ type: 'saavn', data: [] }))
                    );
                }
            }

            if (!type || type === 'music') {
                const url = continuationTokens.music && loadMore
                    ? `${API_ENDPOINTS.music}?continuationToken=${continuationTokens.music}`
                    : `${API_ENDPOINTS.music}?q=${encodeURIComponent(currentQuery)}&filter=songs`;
                promises.push(
                    fetch(url).then(r => r.json()).then(d => {
                        continuationTokens.music = d.continuationToken || null;
                        hasMoreResults.music = !!d.continuationToken;
                        return { type: 'music', data: d.results || [] };
                    }).catch(() => ({ type: 'music', data: [] }))
                );
            }

            if (!type || type === 'videos') {
                const url = continuationTokens.videos && loadMore
                    ? `${API_ENDPOINTS.videos}?continuationToken=${continuationTokens.videos}`
                    : `${API_ENDPOINTS.videos}?q=${encodeURIComponent(currentQuery)}&filter=videos`;
                promises.push(
                    fetch(url).then(r => r.json()).then(d => {
                        continuationTokens.videos = d.continuationToken || null;
                        hasMoreResults.videos = !!d.continuationToken;
                        return { type: 'videos', data: d.results || [] };
                    }).catch(() => ({ type: 'videos', data: [] }))
                );
            }

            try {
                const results = await Promise.all(promises);
                results.forEach(r => {
                    if (loadMore && type === r.type) {
                        searchResults[r.type] = [...searchResults[r.type], ...r.data];
                    } else if (!loadMore) {
                        searchResults[r.type] = r.data;
                    }
                });
                displayResults();
            } catch (e) {
                console.error(e);
                if (!loadMore) resultsContainer.innerHTML = '<div style="text-align:center;padding:60px;color:#ef4444;">Search failed</div>';
            }
        }

        function displayResults() {
            const container = document.querySelector("#search-results");
            let html = '';

            if (currentCategory === 'all') {
                if (searchResults.saavn.length) html += createSection('Saavn', 'saavn', searchResults.saavn, true);
                if (searchResults.music.length) html += createSection('YouTube Music', 'music', searchResults.music, true);
                if (searchResults.videos.length) html += createSection('YouTube', 'videos', searchResults.videos, true);
            } else {
                const data = searchResults[currentCategory] || [];
                if (data.length) {
                    const names = { saavn: 'Songs from Saavn', music: 'Songs from YouTube Music', videos: 'Videos from YouTube' };
                    html += createSection(names[currentCategory], currentCategory, data, false);
                }
            }

            if (!html) html = '<div style="text-align:center;padding:60px;color:rgba(255,255,255,0.6);">No results found</div>';
            container.innerHTML = html;
            addEventListeners();
        }

        function createSection(title, type, items, showBtn = true) {
            if (!items?.length) return '';
            const limit = currentCategory === 'all' ? 6 : items.length;
            const display = items.slice(0, limit);
            let html = `<div class="section" data-type="${type}"><div class="section-header"><h2 class="section-title">${title}</h2>${showBtn && currentCategory === 'all' ? `<button class="show-all-btn" data-category="${type}">Show all</button>` : ''}</div><div class="results-list">`;
            display.forEach(item => { html += createResultItem(item, type); });
            html += '</div></div>';
            return html;
        }

        function createResultItem(item, type) {
            let thumb, title, subtitle, id, cls;
            if (type === 'saavn') {
                thumb = getLowQualityThumbnail(item, type);
                title = item.name || 'Unknown';
                subtitle = `Song • ${item.artists?.primary?.map(a => a.name).join(', ') || 'Unknown'}`;
                if (item.album?.name && item.album.name !== item.name) subtitle += ` • ${item.album.name}`;
                id = `saavn_${item.id}`;
                cls = 'music';
            } else if (type === 'music') {
                thumb = getLowQualityThumbnail(item, type);
                title = item.title || 'Unknown';
                subtitle = `Song • ${item.artists?.map(a => a.name).join(', ') || 'Unknown'}`;
                if (item.album?.name) subtitle += ` • ${item.album.name}`;
                id = `music_${item.videoId}`;
                cls = 'music';
            } else {
                thumb = getLowQualityThumbnail(item, type);
                title = item.title || 'Unknown';
                subtitle = item.channel?.name || 'Unknown';
                if (item.views) subtitle += ` • ${item.views}`;
                id = `video_${item.videoId || item.id}`;
                cls = 'video';
            }
            return `<div class="ytm-list-item ${currentlyPlayingId === id ? 'playing' : ''}" data-id="${id}" data-type="${type}" data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'>
                <img src="${thumb}" class="ytm-thumbnail ${cls}" loading="lazy" alt="">
                <div class="ytm-content"><div class="ytm-title">${title}</div><div class="ytm-subtitle">${subtitle}</div></div>
                <button class="ytm-play-btn"><i class="fa-solid fa-circle-play"></i></button>
            </div>`;
        }

        function addEventListeners() {
            document.querySelectorAll('.show-all-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cat = this.dataset.category;
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.category === cat));
                    currentCategory = cat;
                    displayResults();
                });
            });

            document.querySelectorAll('.ytm-list-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (!e.target.closest('.ytm-play-btn')) {
                        playItem(JSON.parse(this.dataset.item.replace(/&apos;/g, "'")), this.dataset.type);
                    }
                });
                const btn = item.querySelector('.ytm-play-btn');
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        playItem(JSON.parse(item.dataset.item.replace(/&apos;/g, "'")), item.dataset.type);
                    });
                }
            });
        }

        // Infinite Scroll
        let scrollDebounce;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollDebounce);
            scrollDebounce = setTimeout(() => {
                if (isLoadingMore || currentCategory === 'all') return;
                if (!hasMoreResults[currentCategory]) return;
                
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight;
                const clientHeight = window.innerHeight;
                
                if (scrollTop + clientHeight >= scrollHeight - 300) {
                    if (continuationTokens[currentCategory]) {
                        isLoadingMore = true;
                        const container = document.querySelector("#search-results");
                        container.insertAdjacentHTML('beforeend', '<div class="loading-indicator"><div class="loader" style="margin:0 auto 10px;"></div><p>Loading more...</p></div>');
                        performSearch(true, currentCategory).finally(() => {
                            isLoadingMore = false;
                            document.querySelector('.loading-indicator')?.remove();
                        });
                    }
                }
            }, 200);
        });

        // Initialize Audio Context for Lofi
        function initAudioContext() {
            if (audioInitialized) return;
            
            try {
                const audio = document.getElementById('player');
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                sourceNode = audioContext.createMediaElementSource(audio);
                
                // Create reverb
                reverbNode = audioContext.createConvolver();
                const len = 2 * audioContext.sampleRate;
                const buf = audioContext.createBuffer(2, len, audioContext.sampleRate);
                const l = buf.getChannelData(0), r = buf.getChannelData(1);
                for (let i = 0; i < len; i++) {
                    const n = len - i;
                    l[i] = r[i] = (Math.random() * 2 - 1) * Math.pow(n / len, 2);
                }
                reverbNode.buffer = buf;

                // Create gain
                gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(0.7, audioContext.currentTime);

                // Connect: source -> gain -> destination
                sourceNode.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                audioInitialized = true;
            } catch (e) {
                console.error('Audio context init failed:', e);
            }
        }

        // Play with proper lofi
        async function playItem(item, type, updateHist = true) {
            document.querySelectorAll('.ytm-list-item').forEach(el => el.classList.remove('playing'));
            const id = `${type}_${type === 'saavn' ? item.id : item.videoId || item.id}`;
            const curr = document.querySelector(`[data-id="${id}"]`);
            if (curr) curr.classList.add('playing');

            let streamUrl = '', title = '', artist = '', mini = '', high = '';
            try {
                if (type === 'saavn') {
                    const urls = item.downloadUrl;
                    if (urls?.length) streamUrl = urls[4]?.url || urls[3]?.url || urls[2]?.url || urls[1]?.url || urls[0]?.url || '';
                    title = item.name || 'Unknown';
                    artist = item.artists?.primary?.map(a => a.name).join(', ') || 'Unknown';
                    mini = getLowQualityThumbnail(item, type);
                    high = getHighQualityThumbnail(item, type);
                } else {
                    const vid = type === 'music' ? item.videoId : (item.id || item.videoId);
                    const res = await fetch(`${API_ENDPOINTS.streams}/${vid}`);
                    if (!res.ok) throw new Error('Stream error');
                    const data = await res.json();
                    if (!data.streamingData) throw new Error('No stream');
                    let fmt = null;
                    const audio = (data.streamingData.adaptiveFormats || []).filter(f => f.mimeType?.includes('audio')).sort((a,b) => (b.bitrate||0) - (a.bitrate||0));
                    if (audio.length) fmt = audio[0];
                    else { const reg = data.streamingData.formats || []; if (reg.length) fmt = reg[0]; }
                    if (!fmt?.url) throw new Error('No format');
                    streamUrl = fmt.url;
                    title = item.title || 'Unknown';
                    artist = type === 'music' ? (item.artists?.map(a => a.name).join(', ') || 'Unknown') : (item.channel?.name || 'Unknown');
                    mini = getLowQualityThumbnail(item, type);
                    high = getHighQualityThumbnail(item, type);
                }

                if (!streamUrl) throw new Error('No stream');

                currentSongData = { item, type };
                if (updateHist) updateURL(item, type);
                updateTheme(high);

                const isVid = type === 'videos';
                const cls = isVid ? 'rectangle' : 'square';

                const miniArt = document.getElementById("player-image");
                miniArt.className = `mini-player-artwork ${cls}`;
                miniArt.src = mini;
                document.getElementById("player-name").textContent = title;
                document.getElementById("player-album").textContent = artist;

                const expArt = document.getElementById("expanded-artwork");
                const expGlow = document.getElementById("expanded-artwork-glow");
                expArt.className = `expanded-artwork ${cls}`;
                expGlow.className = `expanded-artwork-glow ${cls}`;
                expArt.src = high;
                expGlow.src = high;
                document.getElementById("expanded-title").textContent = title;
                document.getElementById("expanded-artist").textContent = artist;

                initializeMediaSession(title, artist, high);

                const audio = document.getElementById('player');
                audio.src = streamUrl;
                
                // Initialize audio context on first play
                if (!audioInitialized) {
                    initAudioContext();
                }
                
                await audio.play();

                // Apply lofi if enabled
                if (slowedReverbEnabled) {
                    applySlowedReverb();
                }

                document.getElementById("miniPlayer").classList.add('active');
                updatePlayPauseButton(true);
                updateMediaSessionPlaybackState('playing');
                currentlyPlayingId = id;
            } catch (e) {
                console.error(e);
                showNotification(e.message, 'error');
            }
        }

        function showNotification(msg, type = 'info') {
            const n = document.createElement('div');
            n.style.cssText = 'position:fixed;top:90px;right:20px;background:rgba(10,10,20,0.95);backdrop-filter:blur(20px);padding:16px 20px;border-radius:12px;color:white;z-index:9999;max-width:300px;font-size:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);';
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }

        // Audio
        const audio = document.getElementById('player');
        const progress = document.getElementById('progress');
        const expProgress = document.getElementById('expanded-progress');
        const playBtn = document.getElementById('play-pause');
        const expPlay = document.getElementById('expanded-play-pause');
        const lofi = document.getElementById('lofi-toggle');
        const expLofi = document.getElementById('expanded-lofi-toggle');
        const knob = document.getElementById('lofi-knob');

        playBtn.addEventListener('click', togglePlayPause);
        expPlay.addEventListener('click', togglePlayPause);
        lofi.addEventListener('click', toggleSlowedReverb);
        expLofi.addEventListener('click', toggleSlowedReverb);
        audio.addEventListener('timeupdate', updateProgress);
        audio.addEventListener('loadedmetadata', () => {
            document.getElementById('total-time').textContent = formatTime(audio.duration);
        });
        audio.addEventListener('ended', () => {
            updatePlayPauseButton(false);
            updateMediaSessionPlaybackState('paused');
            document.querySelectorAll('.ytm-list-item').forEach(el => el.classList.remove('playing'));
            currentlyPlayingId = null;
        });
        audio.addEventListener('play', () => updateMediaSessionPlaybackState('playing'));
        audio.addEventListener('pause', () => updateMediaSessionPlaybackState('paused'));

        function togglePlayPause() {
            if (audio.paused || audio.ended) {
                audio.play().catch(() => showNotification('Play error', 'error'));
                updatePlayPauseButton(true);
            } else {
                audio.pause();
                updatePlayPauseButton(false);
            }
        }

        function updatePlayPauseButton(playing) {
            const play = '<i class="fa-solid fa-circle-play"></i>';
            const pause = '<i class="fa-solid fa-circle-pause"></i>';
            playBtn.innerHTML = playing ? pause : play;
            expPlay.innerHTML = playing ? pause : play;
        }

        function updateProgress() {
            if (!isNaN(audio.duration) && audio.duration > 0) {
                const p = (audio.currentTime / audio.duration) * 100;
                progress.style.width = `${p}%`;
                expProgress.style.width = `${p}%`;
                document.getElementById('current-time').textContent = formatTime(audio.currentTime);
            }
        }

        function toggleSlowedReverb() {
            slowedReverbEnabled = !slowedReverbEnabled;
            if (slowedReverbEnabled) {
                lofi.classList.add('active');
                knob.style.transform = 'translateX(20px)';
                expLofi.style.color = 'var(--dynamic-primary)';
                if (!audio.paused) applySlowedReverb();
            } else {
                lofi.classList.remove('active');
                knob.style.transform = 'translateX(0)';
                expLofi.style.color = 'rgba(255,255,255,0.7)';
                if (!audio.paused) removeSlowedReverb();
            }
        }

        function applySlowedReverb() {
            if (!audioInitialized || !sourceNode) return;
            
            try {
                audio.preservesPitch = false;
                audio.playbackRate = 0.85;
                
                // Reconnect with reverb
                sourceNode.disconnect();
                gainNode.disconnect();
                
                sourceNode.connect(gainNode);
                gainNode.connect(audioContext.destination);
                sourceNode.connect(reverbNode);
                reverbNode.connect(audioContext.destination);
            } catch (e) {
                console.error('Lofi apply error:', e);
            }
        }

        function removeSlowedReverb() {
            if (!audioInitialized || !sourceNode) return;
            
            try {
                audio.playbackRate = 1;
                audio.preservesPitch = true;
                
                // Remove reverb
                sourceNode.disconnect();
                gainNode.disconnect();
                reverbNode.disconnect();
                
                sourceNode.connect(gainNode);
                gainNode.connect(audioContext.destination);
            } catch (e) {
                console.error('Lofi remove error:', e);
            }
        }

        // Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === ' ') { e.preventDefault(); togglePlayPause(); }
            else if (e.key === '/') { e.preventDefault(); document.getElementById('search-box').focus(); }
            else if (e.key === 'Escape') { e.preventDefault(); closeExpandedPlayer(); hideSuggestions(); }
        });

        // Init
        const hash = window.location.hash;
        if (hash?.startsWith('#search/')) {
            const q = decodeURIComponent(hash.replace('#search/', ''));
            document.getElementById('search-box').value = q;
            performSearch();
        } else {
            document.getElementById('search-box').value = 'phonk';
            performSearch();
        }
    </script>
</body>
</html>
